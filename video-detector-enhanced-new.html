<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºèƒ½è§†é¢‘æ£€æµ‹ä¸‹è½½å·¥å…· - å¢å¼ºç‰ˆ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .tool-switcher {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
        }

        .tool-link {
            padding: 8px 16px;
            background: rgba(255,255,255,0.2);
            color: white;
            text-decoration: none;
            border-radius: 6px;
            font-size: 14px;
            transition: all 0.3s;
        }

        .tool-link:hover {
            background: rgba(255,255,255,0.3);
        }

        .main-content {
            padding: 40px;
        }

        .tool-section {
            background: #f8f9fa;
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 30px;
            border: 2px solid #e9ecef;
        }

        .tool-section h3 {
            color: #495057;
            margin-bottom: 20px;
            font-size: 1.3em;
        }

        .input-group {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }

        .input-field {
            flex: 1;
            padding: 15px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .input-field:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        .btn-warning {
            background: #ffc107;
            color: #212529;
        }

        .btn-warning:hover {
            background: #e0a800;
        }

        .btn-info {
            background: #17a2b8;
            color: white;
        }

        .btn-info:hover {
            background: #138496;
        }

        .controls {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .code-section {
            background: #2d3748;
            color: #e2e8f0;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            overflow-x: auto;
        }

        .code-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #4a5568;
        }

        .code-title {
            color: #90cdf4;
            font-weight: 600;
        }

        .copy-btn {
            background: #4a5568;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        .copy-btn:hover {
            background: #2d3748;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid transparent;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border-color: #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border-color: #f5c6cb;
        }

        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border-color: #ffeaa7;
        }

        .alert-info {
            background: #cce7ff;
            color: #004085;
            border-color: #b8daff;
        }

        .hidden {
            display: none;
        }

        .guide-section {
            background: #e7f3ff;
            border: 2px solid #b8daff;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .guide-section h4 {
            color: #004085;
            margin-bottom: 15px;
        }

        .guide-section ol {
            margin-left: 20px;
        }

        .guide-section li {
            margin-bottom: 8px;
        }

        @media (max-width: 768px) {
            .input-group {
                flex-direction: column;
            }
            
            .controls {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
            }

            .tool-switcher {
                position: static;
                justify-content: center;
                margin-top: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="tool-switcher">
                <a href="m3u8-downloader-enhanced.html" class="tool-link">ğŸ” M3U8å·¥å…·</a>
                <a href="video-tools-hub.html" class="tool-link">ğŸ  å·¥å…·å¹³å°</a>
                <a href="video-test-page.html" class="tool-link">ğŸ§ª æµ‹è¯•é¡µé¢</a>
            </div>
            <h1>ğŸ¬ æ™ºèƒ½è§†é¢‘æ£€æµ‹ä¸‹è½½å·¥å…· - å¢å¼ºç‰ˆ</h1>
            <p>æ™ºèƒ½åˆ†ç±»ã€ä¼˜å…ˆçº§æ’åºã€å®Œç¾å¤„ç†å°é¹…é€šç­‰åœ¨çº¿è¯¾ç¨‹å¹³å°</p>
        </div>

        <div class="main-content">
            <!-- ä½¿ç”¨æŒ‡å— -->
            <div class="guide-section">
                <h4>ğŸ“– ä½¿ç”¨æŒ‡å—</h4>
                <ol>
                    <li><strong>è¾“å…¥ç›®æ ‡ç½‘é¡µURL</strong> - åœ¨ä¸‹æ–¹è¾“å…¥æ¡†ä¸­è¾“å…¥è¦æ£€æµ‹çš„ç½‘é¡µåœ°å€</li>
                    <li><strong>ç”Ÿæˆæ™ºèƒ½æ£€æµ‹ä»£ç </strong> - ç‚¹å‡»"ç”Ÿæˆæ™ºèƒ½æ£€æµ‹ä»£ç "æŒ‰é’®</li>
                    <li><strong>å¤åˆ¶å¹¶æ‰§è¡Œ</strong> - å¤åˆ¶ç”Ÿæˆçš„ä»£ç åˆ°ç›®æ ‡ç½‘é¡µçš„æ§åˆ¶å°æ‰§è¡Œ</li>
                    <li><strong>æŸ¥çœ‹æ™ºèƒ½åˆ†ç±»ç»“æœ</strong> - è‡ªåŠ¨è¿‡æ»¤æ— å…³é“¾æ¥ï¼ŒæŒ‰ä¼˜å…ˆçº§æ’åº</li>
                    <li><strong>ä¸€é”®ä¸‹è½½</strong> - æ ¹æ®è§†é¢‘ç±»å‹é€‰æ‹©åˆé€‚çš„ä¸‹è½½æ–¹å¼</li>
                </ol>
            </div>

            <!-- ç½‘é¡µæ£€æµ‹åŒºåŸŸ -->
            <div class="tool-section">
                <h3>ğŸŒ æ™ºèƒ½è§†é¢‘æ£€æµ‹</h3>
                <div class="input-group">
                    <input type="text" class="input-field" id="targetUrl" placeholder="è¯·è¾“å…¥ç›®æ ‡ç½‘é¡µURLï¼ˆæ”¯æŒå°é¹…é€šã€è…¾è®¯è§†é¢‘ç­‰ï¼‰...">
                    <button class="btn btn-primary" onclick="generateSmartCode()">ğŸ” ç”Ÿæˆæ™ºèƒ½æ£€æµ‹ä»£ç </button>
                </div>
                <div class="controls">
                    <button class="btn btn-secondary" onclick="generateAdvancedCode()">ğŸ”§ é«˜çº§æ£€æµ‹</button>
                    <button class="btn btn-success" onclick="openM3U8Tool()">ğŸ” M3U8å·¥å…·</button>
                    <button class="btn btn-warning" onclick="openTestPage()">ğŸ§ª æµ‹è¯•é¡µé¢</button>
                    <button class="btn btn-info" onclick="showUsageGuide()">ğŸ“– ä½¿ç”¨æŒ‡å—</button>
                </div>
            </div>

            <!-- æ£€æµ‹ä»£ç æ˜¾ç¤ºåŒºåŸŸ -->
            <div class="code-section hidden" id="codeSection">
                <div class="code-header">
                    <div class="code-title">ğŸ“‹ æ™ºèƒ½æ£€æµ‹ä»£ç </div>
                    <button class="copy-btn" onclick="copyCode()">å¤åˆ¶ä»£ç </button>
                </div>
                <pre id="detectionCode"></pre>
            </div>

            <!-- ç»“æœæ˜¾ç¤ºåŒºåŸŸ -->
            <div id="alertContainer"></div>
        </div>
    </div>

    <script>
        // æ˜¾ç¤ºæç¤ºä¿¡æ¯
        function showAlert(message, type = 'info') {
            const alertContainer = document.getElementById('alertContainer');
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-' + type;
            alertDiv.innerHTML = message;
            
            alertContainer.appendChild(alertDiv);
            
            setTimeout(function() {
                alertDiv.remove();
            }, 5000);
        }

        // ç”Ÿæˆæ™ºèƒ½æ£€æµ‹ä»£ç 
        function generateSmartCode() {
            const targetUrl = document.getElementById('targetUrl').value.trim();
            if (!targetUrl) {
                showAlert('è¯·è¾“å…¥ç›®æ ‡ç½‘é¡µURL', 'error');
                return;
            }

            const smartCode = `// æ™ºèƒ½è§†é¢‘æ£€æµ‹å·¥å…· - å¢å¼ºç‰ˆ
// ç›®æ ‡ç½‘é¡µ: ${targetUrl}
// ç”Ÿæˆæ—¶é—´: ${new Date().toLocaleString()}

(function() {
    "use strict";
    
    console.log("ğŸ¬ æ™ºèƒ½è§†é¢‘æ£€æµ‹å·¥å…· - å¢å¼ºç‰ˆå·²å¯åŠ¨");
    
    // æ£€æµ‹åˆ°çš„è§†é¢‘åˆ—è¡¨
    window.detectedVideos = [];
    
    // è§†é¢‘ç±»å‹é…ç½®
    const videoConfig = {
        extensions: {
            primary: [".m3u8", ".mp4", ".webm", ".ogg", ".avi", ".mov"],
            secondary: [".ts", ".flv", ".mkv", ".wmv", ".3gp"]
        },
        keywords: {
            streaming: ["playlist", "stream", "live", "video", "media"],
            xiaoeknow: ["xiaoeknow", "xet.citv", "vodcq"],
            common: ["upload", "content", "asset", "resource"]
        },
        patterns: {
            m3u8: /\\.m3u8(\\?[^\\s]*)?$/i,
            ts: /\\.ts(\\?[^\\s]*)?$/i,
            mp4: /\\.mp4(\\?[^\\s]*)?$/i
        }
    };
    
    // æ£€æµ‹è§†é¢‘å…ƒç´ 
    function detectVideoElements() {
        const videos = [];
        
        // æ£€æµ‹videoæ ‡ç­¾
        document.querySelectorAll("video").forEach(function(video, index) {
            const src = video.src || video.currentSrc;
            if (src && isValidVideoUrl(src)) {
                videos.push({
                    url: src,
                    type: getVideoType(src),
                    element: "video",
                    index: index,
                    priority: getPriority(src),
                    quality: getQuality(src)
                });
            }
            
            // æ£€æµ‹sourceæ ‡ç­¾
            video.querySelectorAll("source").forEach(function(source) {
                const src = source.src;
                if (src && isValidVideoUrl(src)) {
                    videos.push({
                        url: src,
                        type: getVideoType(src),
                        element: "source",
                        priority: getPriority(src),
                        quality: getQuality(src)
                    });
                }
            });
        });
        
        return videos;
    }
    
    // æ£€æµ‹ç½‘ç»œè¯·æ±‚ä¸­çš„è§†é¢‘
    function detectNetworkVideos() {
        const videos = [];
        
        if (window.performance && window.performance.getEntriesByType) {
            const entries = window.performance.getEntriesByType("resource");
            entries.forEach(function(entry) {
                if (isValidVideoUrl(entry.name)) {
                    videos.push({
                        url: entry.name,
                        type: getVideoType(entry.name),
                        element: "network",
                        size: entry.transferSize || 0,
                        priority: getPriority(entry.name),
                        quality: getQuality(entry.name)
                    });
                }
            });
        }
        
        return videos;
    }
    
    // æ£€æµ‹é¡µé¢é“¾æ¥ä¸­çš„è§†é¢‘
    function detectPageLinks() {
        const videos = [];
        
        document.querySelectorAll("a").forEach(function(link) {
            if (isValidVideoUrl(link.href)) {
                videos.push({
                    url: link.href,
                    type: getVideoType(link.href),
                    element: "link",
                    priority: getPriority(link.href),
                    quality: getQuality(link.href)
                });
            }
        });
        
        return videos;
    }
    
    // æ£€æµ‹è„šæœ¬ä¸­çš„è§†é¢‘URL
    function detectScriptVideos() {
        const videos = [];
        
        document.querySelectorAll("script").forEach(function(script) {
            if (script.textContent) {
                const matches = script.textContent.match(/https?:\\/\\/[^\\s"']+\\.(m3u8|mp4|webm|ts)(?:[^\\s"']*)?/gi);
                if (matches) {
                    matches.forEach(function(match) {
                        if (isValidVideoUrl(match)) {
                            videos.push({
                                url: match,
                                type: getVideoType(match),
                                element: "script",
                                priority: getPriority(match),
                                quality: getQuality(match)
                            });
                        }
                    });
                }
            }
        });
        
        return videos;
    }
    
    // åˆ¤æ–­æ˜¯å¦ä¸ºæœ‰æ•ˆçš„è§†é¢‘URL
    function isValidVideoUrl(url) {
        if (!url || typeof url !== 'string') return false;
        
        // è¿‡æ»¤æ‰æ˜æ˜¾çš„éè§†é¢‘URL
        const excludePatterns = [
            /favicon\\.ico/i,
            /\\.css/i,
            /\\.js/i,
            /\\.json/i,
            /\\.xml/i,
            /\\.txt/i,
            /\\.png/i,
            /\\.jpg/i,
            /\\.jpeg/i,
            /\\.gif/i,
            /\\.svg/i,
            /\\.woff/i,
            /\\.ttf/i,
            /google-analytics/i,
            /facebook\\.com/i,
            /twitter\\.com/i,
            /doubleclick/i,
            /adsystem/i,
            /analytics/i,
            /tracking/i,
            /report/i,
            /log/i,
            /stat/i,
            /beacon/i
        ];
        
        if (excludePatterns.some(pattern => pattern.test(url))) {
            return false;
        }
        
        // æ£€æŸ¥æ‰©å±•å
        const allExtensions = videoConfig.extensions.primary.concat(videoConfig.extensions.secondary);
        const hasVideoExtension = allExtensions.some(function(ext) { 
            return url.toLowerCase().includes(ext.toLowerCase()); 
        });
        
        if (hasVideoExtension) return true;
        
        // æ£€æŸ¥è§†é¢‘å¹³å°ç‰¹å¾
        const videoSites = ["youtube", "vimeo", "bilibili", "xiaoeknow", "douyin", "tiktok"];
        return videoSites.some(function(site) { 
            return url.toLowerCase().includes(site); 
        });
    }
    
    // è·å–è§†é¢‘ç±»å‹
    function getVideoType(url) {
        if (!url) return "unknown";
        
        const urlLower = url.toLowerCase();
        
        if (urlLower.includes(".m3u8")) return "m3u8";
        if (urlLower.includes(".ts")) return "ts";
        if (urlLower.includes(".mp4")) return "mp4";
        if (urlLower.includes(".webm")) return "webm";
        if (urlLower.includes(".ogg")) return "ogg";
        if (urlLower.includes(".avi")) return "avi";
        if (urlLower.includes(".mov")) return "mov";
        if (urlLower.includes(".flv")) return "flv";
        if (urlLower.includes(".mkv")) return "mkv";
        
        return "unknown";
    }
    
    // è·å–è§†é¢‘ä¼˜å…ˆçº§
    function getPriority(url) {
        if (!url) return 0;
        
        const urlLower = url.toLowerCase();
        let priority = 0;
        
        // M3U8 ä¸»æ’­æ”¾åˆ—è¡¨ä¼˜å…ˆçº§æœ€é«˜
        if (urlLower.includes(".m3u8")) {
            priority += 100;
            if (urlLower.includes("playlist")) priority += 50;
            if (urlLower.includes("master")) priority += 30;
            if (urlLower.includes("index")) priority += 20;
            if (urlLower.includes("_eof")) priority += 40; // å°é¹…é€šç»“æŸæ ‡è¯†
        }
        
        // MP4 ç›´é“¾ä¼˜å…ˆçº§é«˜
        if (urlLower.includes(".mp4")) {
            priority += 80;
        }
        
        // TS ç‰‡æ®µä¼˜å…ˆçº§è¾ƒä½
        if (urlLower.includes(".ts")) {
            priority += 10;
            // è¿‡æ»¤æ‰æ˜æ˜¾çš„ç‰‡æ®µæ–‡ä»¶
            if (urlLower.match(/_\\d+\\.ts/)) priority -= 5;
        }
        
        // æ ¹æ®å…³é”®è¯è°ƒæ•´ä¼˜å…ˆçº§
        if (urlLower.includes("stream")) priority += 30;
        if (urlLower.includes("live")) priority += 20;
        if (urlLower.includes("video")) priority += 15;
        if (urlLower.includes("media")) priority += 10;
        
        // å°é¹…é€šå¹³å°ç‰¹åˆ«å¤„ç†
        if (urlLower.includes("xiaoeknow")) priority += 40;
        if (urlLower.includes("xet.citv")) priority += 35;
        if (urlLower.includes("vodcq")) priority += 30;
        
        return priority;
    }
    
    // è·å–è§†é¢‘è´¨é‡ä¿¡æ¯
    function getQuality(url) {
        if (!url) return "unknown";
        
        const qualityMarkers = {
            "1920x1080": "1080p",
            "1280x720": "720p",
            "854x480": "480p",
            "640x360": "360p",
            "1080": "1080p",
            "720": "720p",
            "480": "480p",
            "360": "360p"
        };
        
        for (const marker in qualityMarkers) {
            if (url.includes(marker)) {
                return qualityMarkers[marker];
            }
        }
        
        return "unknown";
    }
    
    // æ£€æµ‹æ˜¯å¦åŠ å¯†
    function isEncrypted(url) {
        const encryptionKeywords = ["key", "auth", "token", "encrypt", "secure", "sign"];
        return encryptionKeywords.some(function(keyword) { 
            return url.toLowerCase().includes(keyword); 
        });
    }
    
    // ä¸»æ£€æµ‹å‡½æ•°
    function detectAllVideos() {
        console.log("ğŸ” å¼€å§‹æ™ºèƒ½è§†é¢‘æ£€æµ‹...");
        
        window.detectedVideos = [];
        
        // æ£€æµ‹å„ç§è§†é¢‘æº
        const elementVideos = detectVideoElements();
        const networkVideos = detectNetworkVideos();
        const linkVideos = detectPageLinks();
        const scriptVideos = detectScriptVideos();
        
        // åˆå¹¶å¹¶å»é‡
        const allVideos = elementVideos.concat(networkVideos).concat(linkVideos).concat(scriptVideos);
        window.detectedVideos = allVideos.filter(function(video, index, self) {
            return index === self.findIndex(function(v) { return v.url === video.url; });
        });
        
        // æŒ‰ä¼˜å…ˆçº§æ’åº
        window.detectedVideos.sort(function(a, b) {
            return b.priority - a.priority;
        });
        
        // æ·»åŠ åŠ å¯†æ£€æµ‹
        window.detectedVideos.forEach(function(video) {
            video.encrypted = isEncrypted(video.url);
        });
        
        console.log("âœ… æ™ºèƒ½æ£€æµ‹å®Œæˆï¼Œå‘ç°", window.detectedVideos.length, "ä¸ªè§†é¢‘");
        console.log("ğŸ“Š æ£€æµ‹ç»“æœ:", window.detectedVideos);
        
        // æ˜¾ç¤ºç»“æœ
        showSmartResults();
        
        return window.detectedVideos;
    }
    
    // æ˜¾ç¤ºæ™ºèƒ½ç»“æœ
    function showSmartResults() {
        // ç§»é™¤æ—§çš„æ˜¾ç¤ºæ¡†
        const oldDisplay = document.getElementById("smartVideoResults");
        if (oldDisplay) {
            oldDisplay.remove();
        }
        
        const total = window.detectedVideos.length;
        const m3u8Count = window.detectedVideos.filter(function(v) { return v.type === "m3u8"; }).length;
        const mp4Count = window.detectedVideos.filter(function(v) { return v.type === "mp4"; }).length;
        const tsCount = window.detectedVideos.filter(function(v) { return v.type === "ts"; }).length;
        const encryptedCount = window.detectedVideos.filter(function(v) { return v.encrypted; }).length;
        
        const display = document.createElement("div");
        display.id = "smartVideoResults";
        display.style.cssText = "position: fixed; top: 20px; right: 20px; width: 400px; max-height: 600px; background: white; border: 2px solid #667eea; border-radius: 12px; box-shadow: 0 8px 32px rgba(0,0,0,0.3); z-index: 999999; overflow-y: auto; font-family: Arial, sans-serif;";
        
        let headerHtml = \`<div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px; font-weight: bold; display: flex; justify-content: space-between; align-items: center;">
            ğŸ¬ æ™ºèƒ½æ£€æµ‹ç»“æœ (\${total})
            <button onclick="this.parentElement.parentElement.remove()" style="background: none; border: none; color: white; cursor: pointer; font-size: 18px;">Ã—</button>
        </div>\`;
        
        let statsHtml = \`<div style="padding: 15px; border-bottom: 1px solid #eee;">
            <div style="margin-bottom: 10px;"><strong>ğŸ“Š ç»Ÿè®¡ä¿¡æ¯ï¼š</strong></div>
            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                <span style="background: #e7f3ff; padding: 4px 8px; border-radius: 4px; font-size: 12px;">æ€»æ•°: \${total}</span>
                <span style="background: #fff3cd; padding: 4px 8px; border-radius: 4px; font-size: 12px;">M3U8: \${m3u8Count}</span>
                <span style="background: #d4edda; padding: 4px 8px; border-radius: 4px; font-size: 12px;">MP4: \${mp4Count}</span>
                <span style="background: #f8d7da; padding: 4px 8px; border-radius: 4px; font-size: 12px;">TS: \${tsCount}</span>
                <span style="background: #e2e3e5; padding: 4px 8px; border-radius: 4px; font-size: 12px;">åŠ å¯†: \${encryptedCount}</span>
            </div>
        </div>\`;
        
        display.innerHTML = headerHtml + statsHtml + '<div id="smartVideoList" style="padding: 15px;"></div>';
        
        const videoList = display.querySelector("#smartVideoList");
        
        // æŒ‰ç±»å‹åˆ†ç»„æ˜¾ç¤º
        const groups = {
            "m3u8": { title: "ğŸ¬ M3U8æ’­æ”¾åˆ—è¡¨", videos: [], color: "#856404" },
            "mp4": { title: "ğŸ¥ MP4è§†é¢‘", videos: [], color: "#28a745" },
            "ts": { title: "ğŸ“¹ TSè§†é¢‘ç‰‡æ®µ", videos: [], color: "#6c757d" },
            "other": { title: "ğŸ¦ å…¶ä»–è§†é¢‘", videos: [], color: "#17a2b8" }
        };
        
        window.detectedVideos.forEach(function(video) {
            const group = groups[video.type] || groups.other;
            group.videos.push(video);
        });
        
        Object.keys(groups).forEach(function(key) {
            const group = groups[key];
            if (group.videos.length === 0) return;
            
            const groupDiv = document.createElement("div");
            groupDiv.style.cssText = "margin-bottom: 20px;";
            
            const groupTitle = document.createElement("div");
            groupTitle.style.cssText = "font-weight: bold; margin-bottom: 10px; color: " + group.color + ";";
            groupTitle.textContent = group.title + " (" + group.videos.length + ")";
            groupDiv.appendChild(groupTitle);
            
            group.videos.forEach(function(video, index) {
                const videoItem = document.createElement("div");
                videoItem.style.cssText = "margin-bottom: 10px; padding: 10px; border: 1px solid #ddd; border-radius: 8px; background: #f9f9f9;";
                
                const priorityBadge = \`<span style="background: #17a2b8; color: white; padding: 2px 6px; border-radius: 4px; font-size: 10px;">ä¼˜å…ˆçº§: \${video.priority}</span>\`;
                const qualityBadge = video.quality !== "unknown" ? \`<span style="background: #28a745; color: white; padding: 2px 6px; border-radius: 4px; font-size: 10px;">\${video.quality}</span>\` : "";
                const encryptedBadge = video.encrypted ? \`<span style="background: #f8d7da; color: #721c24; padding: 2px 6px; border-radius: 4px; font-size: 10px;">ğŸ”</span>\` : "";
                
                videoItem.innerHTML = \`
                    <div style="margin-bottom: 8px;">
                        <span style="background: \${group.color}; color: white; padding: 2px 6px; border-radius: 4px; font-size: 11px;">\${video.type.toUpperCase()}</span>
                        \${priorityBadge}
                        \${qualityBadge}
                        \${encryptedBadge}
                    </div>
                    <div style="font-size: 11px; color: #666; margin-bottom: 8px; word-break: break-all; max-height: 60px; overflow: hidden;">\${video.url}</div>
                    <div style="display: flex; gap: 5px; flex-wrap: wrap;">
                        <button onclick="downloadVideo('\${video.url}', '\${video.type}')" style="background: #28a745; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 10px;">ä¸‹è½½</button>
                        <button onclick="copyVideoUrl('\${video.url}')" style="background: #6c757d; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 10px;">å¤åˆ¶</button>
                        \${video.type === "m3u8" ? \`<button onclick="openM3U8ToolWithUrl('\${video.url}')" style="background: #ffc107; color: #212529; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 10px;">M3U8å·¥å…·</button>\` : ""}
                    </div>
                \`;
                
                groupDiv.appendChild(videoItem);
            });
            
            videoList.appendChild(groupDiv);
        });
        
        document.body.appendChild(display);
    }
    
    // ä¸‹è½½è§†é¢‘
    window.downloadVideo = function(url, type) {
        if (type === "m3u8") {
            alert("M3U8è§†é¢‘å»ºè®®ä½¿ç”¨ä¸“ç”¨å·¥å…·ä¸‹è½½");
            return;
        }
        
        const a = document.createElement("a");
        a.href = url;
        a.download = url.split("/").pop() || "video";
        a.target = "_blank";
        a.click();
    };
    
    // å¤åˆ¶è§†é¢‘URL
    window.copyVideoUrl = function(url) {
        navigator.clipboard.writeText(url).then(function() {
            alert("é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿");
        }).catch(function() {
            prompt("è¯·å¤åˆ¶æ­¤é“¾æ¥:", url);
        });
    };
    
    // æ‰“å¼€M3U8å·¥å…·
    window.openM3U8ToolWithUrl = function(url) {
        const newWindow = window.open("", "_blank");
        newWindow.document.write(\`
            <html>
                <head><title>M3U8å·¥å…·</title></head>
                <body style="font-family: Arial, sans-serif; padding: 20px;">
                    <h2>ğŸ” M3U8è§†é¢‘å¤„ç†</h2>
                    <p>æ£€æµ‹åˆ°çš„é“¾æ¥ï¼š</p>
                    <textarea style="width: 100%; height: 100px;" readonly>\${url}</textarea>
                    <br><br>
                    <button onclick="navigator.clipboard.writeText('\${url}'); alert('å·²å¤åˆ¶');">å¤åˆ¶é“¾æ¥</button>
                    <p style="color: #666; margin-top: 20px;">å»ºè®®ä½¿ç”¨ä¸“ç”¨çš„M3U8ä¸‹è½½å·¥å…·è¿›è¡Œå¤„ç†</p>
                </body>
            </html>
        \`);
    };
    
    // ç«‹å³æ‰§è¡Œæ£€æµ‹
    detectAllVideos();
    
    // å®šæœŸæ£€æµ‹
    setInterval(detectAllVideos, 5000);
    
    console.log("ğŸ‰ æ™ºèƒ½è§†é¢‘æ£€æµ‹å·¥å…·åˆå§‹åŒ–å®Œæˆï¼");
    
})();`;

            // æ˜¾ç¤ºä»£ç 
            document.getElementById('codeSection').classList.remove('hidden');
            document.getElementById('detectionCode').textContent = smartCode;
            
            showAlert('æ™ºèƒ½æ£€æµ‹ä»£ç å·²ç”Ÿæˆï¼æ­¤ç‰ˆæœ¬ä¼šè‡ªåŠ¨è¿‡æ»¤æ— å…³é“¾æ¥å¹¶æŒ‰ä¼˜å…ˆçº§æ’åº', 'success');
        }

        // ç”Ÿæˆé«˜çº§æ£€æµ‹ä»£ç 
        function generateAdvancedCode() {
            const targetUrl = document.getElementById('targetUrl').value.trim();
            if (!targetUrl) {
                showAlert('è¯·è¾“å…¥ç›®æ ‡ç½‘é¡µURL', 'error');
                return;
            }

            const advancedCode = `// é«˜çº§è§†é¢‘æ£€æµ‹å·¥å…· - æ·±åº¦æ‰«æ
console.log("ğŸ” é«˜çº§è§†é¢‘æ£€æµ‹å·¥å…·å¯åŠ¨");

// æ·±åº¦æ‰«ææ‰€æœ‰å…ƒç´ 
const allElements = document.querySelectorAll("*");
const videoUrls = [];
const seenUrls = new Set();

// æ‰«ææ‰€æœ‰å…ƒç´ çš„å±æ€§
allElements.forEach(function(el) {
    const attrs = ["src", "data-src", "data-url", "href", "data-video", "data-stream"];
    attrs.forEach(function(attr) {
        const value = el.getAttribute(attr);
        if (value && !seenUrls.has(value)) {
            if (value.match(/\\.(mp4|m3u8|webm|ts|avi|mov|flv|mkv)/i)) {
                videoUrls.push({url: value, source: "attribute:" + attr});
                seenUrls.add(value);
            }
        }
    });
});

// æ‰«æJavaScriptå˜é‡å’Œå¯¹è±¡
const scripts = document.querySelectorAll("script");
scripts.forEach(function(script) {
    if (script.textContent) {
        const matches = script.textContent.match(/https?:\\/\\/[^\\s"']+\\.(m3u8|mp4|webm|ts|avi|mov|flv|mkv)(?:[^\\s"']*)?/gi);
        if (matches) {
            matches.forEach(function(match) {
                if (!seenUrls.has(match)) {
                    videoUrls.push({url: match, source: "script"});
                    seenUrls.add(match);
                }
            });
        }
    }
});

// æ‰«æCSSæ ·å¼
const styles = document.querySelectorAll("style, link[rel='stylesheet']");
styles.forEach(function(style) {
    if (style.textContent) {
        const matches = style.textContent.match(/url\\([^)]*\\.(mp4|webm|ogg)[^)]*\\)/gi);
        if (matches) {
            matches.forEach(function(match) {
                const url = match.replace(/url\\(["']?([^"')]+)["']?\\)/, '$1');
                if (!seenUrls.has(url)) {
                    videoUrls.push({url: url, source: "css"});
                    seenUrls.add(url);
                }
            });
        }
    }
});

// æ‰«æwindowå¯¹è±¡
function scanObject(obj, path = 'window', depth = 0) {
    if (depth > 3) return; // é™åˆ¶é€’å½’æ·±åº¦
    
    try {
        for (const key in obj) {
            if (obj.hasOwnProperty(key)) {
                const value = obj[key];
                if (typeof value === 'string' && value.match(/https?:\\/\\/.*\\.(mp4|m3u8|webm|ts)/i)) {
                    if (!seenUrls.has(value)) {
                        videoUrls.push({url: value, source: path + '.' + key});
                        seenUrls.add(value);
                    }
                } else if (typeof value === 'object' && value !== null) {
                    scanObject(value, path + '.' + key, depth + 1);
                }
            }
        }
    } catch (e) {
        // å¿½ç•¥è®¿é—®å—é™çš„å±æ€§
    }
}

scanObject(window);

// æ˜¾ç¤ºç»“æœ
console.log("ğŸ¯ é«˜çº§æ£€æµ‹å®Œæˆï¼Œå‘ç°", videoUrls.length, "ä¸ªè§†é¢‘");
videoUrls.forEach(function(item, index) {
    console.log((index + 1) + ":", item.url, "(" + item.source + ")");
});

// åˆ›å»ºç»“æœæ˜¾ç¤º
const resultDiv = document.createElement('div');
resultDiv.style.cssText = 'position: fixed; top: 20px; left: 20px; width: 400px; max-height: 500px; background: white; border: 2px solid #dc3545; border-radius: 12px; box-shadow: 0 8px 32px rgba(0,0,0,0.3); z-index: 999999; overflow-y: auto; font-family: Arial, sans-serif;';
resultDiv.innerHTML = '<div style="background: #dc3545; color: white; padding: 15px; font-weight: bold;">ğŸ” é«˜çº§æ£€æµ‹ç»“æœ (' + videoUrls.length + ')<button onclick="this.parentElement.parentElement.remove()" style="background: none; border: none; color: white; cursor: pointer; font-size: 18px; float: right;">Ã—</button></div><div style="padding: 15px; font-size: 12px;">' + videoUrls.map(function(item, index) {
    return '<div style="margin-bottom: 10px; padding: 8px; border: 1px solid #ddd; border-radius: 4px;"><strong>' + (index + 1) + ':</strong><br><span style="word-break: break-all;">' + item.url + '</span><br><small style="color: #666;">æ¥æº: ' + item.source + '</small></div>';
}).join('') + '</div>';

document.body.appendChild(resultDiv);

console.log("âœ… é«˜çº§æ£€æµ‹å®Œæˆ");`;

            document.getElementById('codeSection').classList.remove('hidden');
            document.getElementById('detectionCode').textContent = advancedCode;
            
            showAlert('é«˜çº§æ£€æµ‹ä»£ç å·²ç”Ÿæˆï¼æ­¤ç‰ˆæœ¬è¿›è¡Œæ›´æ·±åº¦çš„æ‰«æ', 'success');
        }

        // å¤åˆ¶ä»£ç 
        function copyCode() {
            const code = document.getElementById('detectionCode').textContent;
            navigator.clipboard.writeText(code).then(function() {
                showAlert('ä»£ç å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
            }).catch(function() {
                showAlert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶', 'error');
            });
        }

        // æ‰“å¼€M3U8å·¥å…·
        function openM3U8Tool() {
            window.open('m3u8-downloader-enhanced.html', '_blank');
        }

        // æ‰“å¼€æµ‹è¯•é¡µé¢
        function openTestPage() {
            window.open('video-test-page.html', '_blank');
        }

        // æ˜¾ç¤ºä½¿ç”¨æŒ‡å—
        function showUsageGuide() {
            const guide = '<div class="alert alert-info">' +
                '<h4>ğŸ“– ä½¿ç”¨æŒ‡å—</h4>' +
                '<ol>' +
                '<li><strong>è¾“å…¥ç›®æ ‡ç½‘é¡µURL</strong> - åœ¨è¾“å…¥æ¡†ä¸­è¾“å…¥è¦æ£€æµ‹çš„ç½‘é¡µåœ°å€</li>' +
                '<li><strong>ç”Ÿæˆæ™ºèƒ½æ£€æµ‹ä»£ç </strong> - ç‚¹å‡»"ç”Ÿæˆæ™ºèƒ½æ£€æµ‹ä»£ç "æŒ‰é’®</li>' +
                '<li><strong>å¤åˆ¶å¹¶æ‰§è¡Œ</strong> - å¤åˆ¶ç”Ÿæˆçš„ä»£ç åˆ°ç›®æ ‡ç½‘é¡µçš„æ§åˆ¶å°æ‰§è¡Œ</li>' +
                '<li><strong>æŸ¥çœ‹æ™ºèƒ½åˆ†ç±»ç»“æœ</strong> - åœ¨ç›®æ ‡ç½‘é¡µå³ä¾§ä¼šæ˜¾ç¤ºåˆ†ç±»åçš„æ£€æµ‹ç»“æœ</li>' +
                '<li><strong>é€‰æ‹©åˆé€‚çš„è§†é¢‘</strong> - æ ¹æ®ä¼˜å…ˆçº§æ’åºï¼Œé€‰æ‹©è´¨é‡æœ€å¥½çš„è§†é¢‘</li>' +
                '<li><strong>ä¸‹è½½è§†é¢‘</strong> - ç‚¹å‡»ç›¸åº”çš„ä¸‹è½½æŒ‰é’®æˆ–ä½¿ç”¨M3U8å·¥å…·</li>' +
                '</ol>' +
                '<p><strong>æ–°åŠŸèƒ½</strong>ï¼š</p>' +
                '<ul>' +
                '<li>ğŸ¯ æ™ºèƒ½è¿‡æ»¤æ— å…³é“¾æ¥ï¼ˆå¦‚ç»Ÿè®¡ã€å¹¿å‘Šé“¾æ¥ï¼‰</li>' +
                '<li>ğŸ“Š æŒ‰ä¼˜å…ˆçº§è‡ªåŠ¨æ’åº</li>' +
                '<li>ğŸ” ç‰¹åˆ«ä¼˜åŒ–å°é¹…é€šç­‰åœ¨çº¿è¯¾ç¨‹å¹³å°</li>' +
                '<li>ğŸ¬ æŒ‰è§†é¢‘ç±»å‹æ™ºèƒ½åˆ†ç»„æ˜¾ç¤º</li>' +
                '<li>ğŸ’ æ˜¾ç¤ºè§†é¢‘è´¨é‡ä¿¡æ¯</li>' +
                '</ul>' +
                '<p><strong>æç¤º</strong>ï¼šå¯¹äºå°é¹…é€šç­‰å¹³å°ï¼Œä¼˜å…ˆé€‰æ‹©M3U8æ’­æ”¾åˆ—è¡¨ç±»å‹çš„è§†é¢‘ã€‚</p>' +
                '</div>';
            
            const mainContent = document.querySelector('.main-content');
            const guideDiv = document.createElement('div');
            guideDiv.innerHTML = guide;
            mainContent.insertBefore(guideDiv, mainContent.firstChild);
            
            setTimeout(function() {
                guideDiv.remove();
            }, 15000);
        }

        // é¡µé¢åŠ è½½å®Œæˆ
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸ¬ æ™ºèƒ½è§†é¢‘æ£€æµ‹å·¥å…· - å¢å¼ºç‰ˆå·²åŠ è½½');
            
            // æ£€æŸ¥æ˜¯å¦æœ‰ä¼ é€’çš„URL
            const urlParams = new URLSearchParams(window.location.search);
            const url = urlParams.get('url');
            if (url) {
                document.getElementById('targetUrl').value = url;
            }
        });
    </script>
</body>
</html>