<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>M3U8 å¢å¼ºç‰ˆä¸‹è½½å·¥å…·</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }

        .tool-switcher {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
        }

        .tool-link {
            padding: 8px 16px;
            background: rgba(255,255,255,0.2);
            color: white;
            text-decoration: none;
            border-radius: 6px;
            font-size: 14px;
            transition: all 0.3s;
        }

        .tool-link:hover {
            background: rgba(255,255,255,0.3);
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .main-content {
            padding: 40px;
        }

        .input-section {
            background: #f8f9fa;
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 30px;
            border: 2px solid #e9ecef;
        }

        .input-group {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }

        .input-field {
            flex: 1;
            padding: 15px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .input-field:focus {
            outline: none;
            border-color: #667eea;
        }

        .file-input {
            display: none;
        }

        .file-label {
            padding: 15px 30px;
            background: #28a745;
            color: white;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s;
        }

        .file-label:hover {
            background: #218838;
            transform: translateY(-2px);
        }

        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        .btn-warning {
            background: #ffc107;
            color: #212529;
        }

        .btn-warning:hover {
            background: #e0a800;
        }

        .format-selector {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }

        .format-option {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .format-option input[type="radio"] {
            width: 20px;
            height: 20px;
        }

        .controls {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            text-align: center;
            border: 2px solid #e9ecef;
        }

        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #6c757d;
            font-size: 0.9em;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin: 15px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s ease;
            border-radius: 10px;
        }

        .log-section {
            background: #000;
            color: #00ff00;
            padding: 20px;
            border-radius: 12px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            max-height: 400px;
            overflow-y: auto;
            margin-bottom: 20px;
        }

        .encryption-info {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .encryption-info h3 {
            color: #856404;
            margin-bottom: 15px;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .alert-info {
            background: #cce7ff;
            color: #004085;
            border: 1px solid #b8daff;
        }

        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .hidden {
            display: none;
        }

        .ffmpeg-section {
            background: #f1f3f4;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            border-left: 4px solid #667eea;
        }

        .ffmpeg-command {
            background: #2d3748;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            margin: 10px 0;
            overflow-x: auto;
        }

        .method-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .tab {
            padding: 10px 20px;
            background: #e9ecef;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .tab.active {
            background: #667eea;
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .advanced-options {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
            margin-top: 20px;
            border: 2px solid #e9ecef;
        }

        .options-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .option-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .option-group label {
            font-weight: 600;
            color: #495057;
        }

        .option-group select,
        .option-group input {
            padding: 8px 12px;
            border: 1px solid #ced4da;
            border-radius: 6px;
            font-size: 14px;
        }

        .option-group select:focus,
        .option-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .status-indicator {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-loading {
            background: #fff3cd;
            color: #856404;
        }

        .status-ready {
            background: #d4edda;
            color: #155724;
        }

        .status-error {
            background: #f8d7da;
            color: #721c24;
        }

        @media (max-width: 768px) {
            .input-group {
                flex-direction: column;
            }
            
            .controls {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
            }
            
            .options-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="tool-switcher">
                <a href="video-detector-enhanced.html" class="tool-link">ğŸ¬ è§†é¢‘æ£€æµ‹</a>
                <a href="video-test-page.html" class="tool-link">ğŸ§ª æµ‹è¯•é¡µé¢</a>
                <a href="m3u8-encrypted-downloader.sh" class="tool-link">âš¡ å‘½ä»¤è¡Œ</a>
            </div>
            <h1>ğŸ¬ M3U8 å¢å¼ºç‰ˆä¸‹è½½å·¥å…·</h1>
            <p>æ”¯æŒåŠ å¯†è§†é¢‘ã€æœ¬åœ°æ–‡ä»¶ã€å¤šç§ä¸‹è½½æ–¹å¼</p>
        </div>

        <div class="main-content">
            <!-- æ–¹æ³•é€‰æ‹©æ ‡ç­¾ -->
            <div class="method-tabs">
                <button class="tab active" onclick="switchTab('browser')">ğŸŒ æµè§ˆå™¨ä¸‹è½½</button>
                <button class="tab" onclick="switchTab('ffmpeg')">âš¡ FFmpeg ä¸‹è½½</button>
                <button class="tab" onclick="switchTab('local')">ğŸ“ æœ¬åœ°æ–‡ä»¶</button>
            </div>

            <!-- æµè§ˆå™¨ä¸‹è½½æ–¹å¼ -->
            <div class="tab-content active" id="browser-tab">
                <div class="input-section">
                    <h3>ğŸ“¥ æµè§ˆå™¨ä¸‹è½½æ–¹å¼</h3>
                    <div class="input-group">
                        <input type="text" class="input-field" id="m3u8Url" placeholder="è¯·è¾“å…¥ M3U8 é“¾æ¥åœ°å€...">
                        <button class="btn btn-primary" onclick="parseM3U8()">ğŸ” è§£æä¸‹è½½</button>
                    </div>
                    
                    <div class="format-selector">
                        <label class="format-option">
                            <input type="radio" name="format" value="mp4" checked>
                            <span>MP4 æ ¼å¼</span>
                        </label>
                        <label class="format-option">
                            <input type="radio" name="format" value="ts">
                            <span>TS æ ¼å¼</span>
                        </label>
                        <label class="format-option">
                            <input type="radio" name="format" value="m3u8">
                            <span>M3U8 æ ¼å¼</span>
                        </label>
                    </div>

                    <div class="controls">
                        <button class="btn btn-secondary" onclick="retryFailedSegments()">ğŸ”„ é‡è¯•å¤±è´¥ç‰‡æ®µ</button>
                        <button class="btn btn-success" onclick="forceDownload()">âš¡ å¼ºåˆ¶ä¸‹è½½</button>
                        <button class="btn btn-danger" onclick="clearAll()">ğŸ—‘ï¸ æ¸…ç©ºé‡ç½®</button>
                    </div>
                </div>

                <!-- åŠ å¯†ä¿¡æ¯æ˜¾ç¤º -->
                <div class="encryption-info hidden" id="encryptionInfo">
                    <h3>ğŸ” æ£€æµ‹åˆ°åŠ å¯†è§†é¢‘</h3>
                    <p>æ­¤è§†é¢‘ä½¿ç”¨äº†åŠ å¯†ä¿æŠ¤ï¼Œæµè§ˆå™¨ä¸‹è½½å¯èƒ½æ— æ³•æ­£å¸¸å¤„ç†ã€‚</p>
                    <p><strong>å»ºè®®</strong>ï¼šåˆ‡æ¢åˆ° "FFmpeg ä¸‹è½½" æ–¹å¼è·å¾—æ›´å¥½çš„å…¼å®¹æ€§ã€‚</p>
                </div>
            </div>

            <!-- FFmpeg ä¸‹è½½æ–¹å¼ -->
            <div class="tab-content" id="ffmpeg-tab">
                <div class="ffmpeg-section">
                    <h3>âš¡ FFmpeg ä¸“ä¸šä¸‹è½½</h3>
                    <p>ä½¿ç”¨ FFmpeg å¯ä»¥å¤„ç†åŠ å¯†çš„ M3U8 è§†é¢‘ï¼Œæ”¯æŒæ›´å¤šæ ¼å¼å’Œé€‰é¡¹ã€‚</p>
                    
                    <div class="input-group">
                        <input type="text" class="input-field" id="ffmpegUrl" placeholder="è¯·è¾“å…¥ M3U8 é“¾æ¥åœ°å€...">
                        <button class="btn btn-primary" onclick="generateFFmpegCommand()">ğŸ”§ ç”Ÿæˆå‘½ä»¤</button>
                    </div>

                    <div class="format-selector">
                        <label class="format-option">
                            <input type="radio" name="ffmpeg-format" value="mp4" checked>
                            <span>MP4 æ ¼å¼</span>
                        </label>
                        <label class="format-option">
                            <input type="radio" name="ffmpeg-format" value="mkv">
                            <span>MKV æ ¼å¼</span>
                        </label>
                        <label class="format-option">
                            <input type="radio" name="ffmpeg-format" value="ts">
                            <span>TS æ ¼å¼</span>
                        </label>
                    </div>

                    <div class="controls">
                        <button class="btn btn-warning" onclick="copyFFmpegCommand()">ğŸ“‹ å¤åˆ¶å‘½ä»¤</button>
                        <button class="btn btn-success" onclick="executeFFmpeg()">â³ åˆå§‹åŒ–ä¸­...</button>
                        <button class="btn btn-info" onclick="showAdvancedOptions()">âš™ï¸ é«˜çº§é€‰é¡¹</button>
                    </div>

                    <div class="ffmpeg-command hidden" id="ffmpegCommand"></div>
                    
                    <!-- é«˜çº§é€‰é¡¹é¢æ¿ -->
                    <div class="advanced-options hidden" id="advancedOptions">
                        <h4>ğŸ”§ é«˜çº§å¤„ç†é€‰é¡¹</h4>
                        <div class="options-grid">
                            <div class="option-group">
                                <label>è§†é¢‘ç¼–ç å™¨ï¼š</label>
                                <select id="videoCodec">
                                    <option value="copy">ç›´æ¥å¤åˆ¶ (æœ€å¿«)</option>
                                    <option value="libx264">H.264 (é€šç”¨)</option>
                                    <option value="libx265">H.265 (é«˜å‹ç¼©)</option>
                                </select>
                            </div>
                            <div class="option-group">
                                <label>è§†é¢‘æ¯”ç‰¹ç‡ï¼š</label>
                                <input type="text" id="videoBitrate" placeholder="å¦‚: 2000k">
                            </div>
                            <div class="option-group">
                                <label>åˆ†è¾¨ç‡ï¼š</label>
                                <select id="resolution">
                                    <option value="">ä¿æŒåŸå§‹</option>
                                    <option value="1920x1080">1080p</option>
                                    <option value="1280x720">720p</option>
                                    <option value="854x480">480p</option>
                                </select>
                            </div>
                            <div class="option-group">
                                <label>å¸§ç‡ï¼š</label>
                                <input type="text" id="fps" placeholder="å¦‚: 30">
                            </div>
                            <div class="option-group">
                                <label>éŸ³é¢‘æ¯”ç‰¹ç‡ï¼š</label>
                                <input type="text" id="audioBitrate" placeholder="å¦‚: 128k">
                            </div>
                        </div>
                        <div class="controls">
                            <button class="btn btn-primary" onclick="executeAdvancedFFmpegFromUI()">ğŸš€ é«˜çº§å¤„ç†</button>
                            <button class="btn btn-secondary" onclick="hideAdvancedOptions()">âŒ å…³é—­</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- æœ¬åœ°æ–‡ä»¶æ–¹å¼ -->
            <div class="tab-content" id="local-tab">
                <div class="input-section">
                    <h3>ğŸ“ æœ¬åœ° M3U8 æ–‡ä»¶</h3>
                    <p>é€‰æ‹©å·²ä¸‹è½½çš„ M3U8 æ–‡ä»¶è¿›è¡Œå¤„ç†</p>
                    
                    <div class="input-group">
                        <input type="file" class="file-input" id="localFile" accept=".m3u8,.m3u" onchange="handleLocalFile()">
                        <label for="localFile" class="file-label">ğŸ“‚ é€‰æ‹©æœ¬åœ°æ–‡ä»¶</label>
                        <button class="btn btn-primary" onclick="parseLocalM3U8()">ğŸ” è§£ææ–‡ä»¶</button>
                    </div>

                    <div class="controls">
                        <button class="btn btn-warning" onclick="generateLocalFFmpegCommand()">âš¡ ç”Ÿæˆ FFmpeg å‘½ä»¤</button>
                        <button class="btn btn-success" onclick="processLocalFile()">ğŸ”§ å¤„ç†æ–‡ä»¶</button>
                    </div>

                    <div class="alert alert-info">
                        <strong>æç¤ºï¼š</strong>æœ¬åœ°æ–‡ä»¶æ–¹å¼é€‚ç”¨äºå·²ç»ä¸‹è½½çš„ M3U8 æ–‡ä»¶ï¼Œå¯ä»¥ç”Ÿæˆå¯¹åº”çš„ FFmpeg å‘½ä»¤è¿›è¡Œå¤„ç†ã€‚
                    </div>
                </div>
            </div>

            <!-- ç»Ÿè®¡ä¿¡æ¯ -->
            <div class="stats-grid hidden" id="statsSection">
                <div class="stat-card">
                    <div class="stat-number" id="totalSegments">0</div>
                    <div class="stat-label">æ€»ç‰‡æ®µæ•°</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="downloadedSegments">0</div>
                    <div class="stat-label">å·²ä¸‹è½½</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="failedSegments">0</div>
                    <div class="stat-label">ä¸‹è½½å¤±è´¥</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="downloadProgress">0%</div>
                    <div class="stat-label">ä¸‹è½½è¿›åº¦</div>
                </div>
            </div>

            <!-- è¿›åº¦æ¡ -->
            <div class="progress-bar hidden" id="progressBar">
                <div class="progress-fill" id="progressFill"></div>
            </div>

            <!-- æ—¥å¿—è¾“å‡º -->
            <div class="log-section hidden" id="logSection">
                <div id="logOutput"></div>
            </div>
        </div>
    </div>

    <!-- FFmpeg WebAssembly æ”¯æŒ -->
    <script src="https://unpkg.com/@ffmpeg/util@0.12.1/dist/umd/index.js"></script>
    <script src="https://unpkg.com/@ffmpeg/ffmpeg@0.12.10/dist/umd/index.js"></script>
    
    <script>
        // å…¨å±€å˜é‡
        let segments = [];
        let downloadedSegments = [];
        let failedSegments = [];
        let isDownloading = false;
        let encryptionKey = null;
        let encryptionIV = null;
        let baseUrl = '';
        let currentLocalFile = null;
        
        // FFmpeg WebAssembly ç›¸å…³
        let ffmpeg = null;
        let ffmpegLoaded = false;
        let isFFmpegProcessing = false;

        // åˆ‡æ¢æ ‡ç­¾
        function switchTab(tabName) {
            // éšè—æ‰€æœ‰æ ‡ç­¾å†…å®¹
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // ç§»é™¤æ‰€æœ‰æ ‡ç­¾çš„æ¿€æ´»çŠ¶æ€
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // æ˜¾ç¤ºé€‰ä¸­çš„æ ‡ç­¾å†…å®¹
            document.getElementById(tabName + '-tab').classList.add('active');
            
            // æ¿€æ´»é€‰ä¸­çš„æ ‡ç­¾
            event.target.classList.add('active');
            
            // å¦‚æœåˆ‡æ¢åˆ° FFmpeg æ ‡ç­¾ï¼Œåˆå§‹åŒ– FFmpeg
            if (tabName === 'ffmpeg' && !ffmpegLoaded) {
                initFFmpeg();
            }
        }

        // åˆå§‹åŒ– FFmpeg WebAssembly
        async function initFFmpeg() {
            if (ffmpegLoaded || isFFmpegProcessing) return;
            
            try {
                log('æ­£åœ¨åˆå§‹åŒ– FFmpeg WebAssembly...', 'info');
                showAlert('æ­£åœ¨åŠ è½½ FFmpegï¼Œè¯·ç¨å€™...', 'info');
                
                const { FFmpeg } = FFmpegWASM;
                const { toBlobURL } = FFmpegUtil;
                
                ffmpeg = new FFmpeg();
                
                // ç›‘å¬è¿›åº¦å’Œæ—¥å¿—
                ffmpeg.on('log', ({ message }) => {
                    log(`FFmpeg: ${message}`, 'info');
                });
                
                ffmpeg.on('progress', ({ progress, time }) => {
                    const percent = Math.round(progress * 100);
                    log(`FFmpeg è¿›åº¦: ${percent}% (${time}s)`, 'info');
                    updateFFmpegProgress(percent);
                });
                
                // åŠ è½½ FFmpeg æ ¸å¿ƒæ–‡ä»¶
                const baseURL = 'https://unpkg.com/@ffmpeg/core@0.12.6/dist/umd';
                await ffmpeg.load({
                    coreURL: await toBlobURL(`${baseURL}/ffmpeg-core.js`, 'text/javascript'),
                    wasmURL: await toBlobURL(`${baseURL}/ffmpeg-core.wasm`, 'application/wasm'),
                });
                
                ffmpegLoaded = true;
                log('FFmpeg WebAssembly åˆå§‹åŒ–æˆåŠŸï¼', 'success');
                showAlert('FFmpeg åŠ è½½å®Œæˆï¼ç°åœ¨å¯ä»¥ç›´æ¥åœ¨ç½‘é¡µæ‰§è¡Œè§†é¢‘å¤„ç†', 'success');
                
                // æ›´æ–°çŠ¶æ€å’ŒæŒ‰é’®
                updateFFmpegStatus('ready', 'âœ… å·²å°±ç»ª');
                updateFFmpegButtons();
                
            } catch (error) {
                log(`FFmpeg åˆå§‹åŒ–å¤±è´¥: ${error.message}`, 'error');
                showAlert(`FFmpeg åˆå§‹åŒ–å¤±è´¥: ${error.message}`, 'error');
                updateFFmpegStatus('error', 'âŒ åˆå§‹åŒ–å¤±è´¥');
            }
        }

        // æ›´æ–° FFmpeg è¿›åº¦æ˜¾ç¤º
        function updateFFmpegProgress(percent) {
            const progressBar = document.getElementById('progressBar');
            const progressFill = document.getElementById('progressFill');
            
            progressBar.classList.remove('hidden');
            progressFill.style.width = percent + '%';
            
            // æ›´æ–°è¿›åº¦æ–‡æœ¬
            const progressText = document.getElementById('downloadProgress');
            if (progressText) {
                progressText.textContent = percent + '%';
            }
        }

        // æ›´æ–° FFmpeg æŒ‰é’®çŠ¶æ€
        function updateFFmpegButtons() {
            const executeBtn = document.querySelector('[onclick="executeFFmpeg()"]');
            if (executeBtn) {
                if (ffmpegLoaded) {
                    executeBtn.textContent = 'â–¶ï¸ ç½‘é¡µç«¯æ‰§è¡Œ';
                    executeBtn.classList.remove('btn-secondary');
                    executeBtn.classList.add('btn-success');
                } else {
                    executeBtn.textContent = 'â³ åŠ è½½ä¸­...';
                    executeBtn.classList.add('btn-secondary');
                    executeBtn.classList.remove('btn-success');
                }
            }
        }

        // æ—¥å¿—è¾“å‡º
        function log(message, type = 'info') {
            const logOutput = document.getElementById('logOutput');
            const logSection = document.getElementById('logSection');
            const timestamp = new Date().toLocaleTimeString();
            const color = type === 'error' ? '#ff6b6b' : type === 'success' ? '#51cf66' : type === 'warning' ? '#ffd93d' : '#00ff00';
            
            logOutput.innerHTML += `<div style="color: ${color};">[${timestamp}] ${message}</div>`;
            logSection.scrollTop = logSection.scrollHeight;
            logSection.classList.remove('hidden');
        }

        // æ˜¾ç¤ºæç¤ºä¿¡æ¯
        function showAlert(message, type = 'info') {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.innerHTML = message;
            
            const mainContent = document.querySelector('.main-content');
            mainContent.insertBefore(alertDiv, mainContent.firstChild);
            
            setTimeout(() => {
                alertDiv.remove();
            }, 5000);
        }

        // è§£æ M3U8 æ–‡ä»¶
        async function parseM3U8() {
            const url = document.getElementById('m3u8Url').value.trim();
            if (!url) {
                showAlert('è¯·è¾“å…¥ M3U8 é“¾æ¥åœ°å€', 'error');
                return;
            }

            if (!url.includes('.m3u8')) {
                showAlert('è¯·è¾“å…¥æœ‰æ•ˆçš„ M3U8 é“¾æ¥', 'error');
                return;
            }

            log('å¼€å§‹è§£æ M3U8 æ–‡ä»¶...');
            
            try {
                baseUrl = url.substring(0, url.lastIndexOf('/') + 1);
                
                // å°è¯•ä½¿ç”¨ä¸åŒçš„æ–¹æ³•è·å–M3U8æ–‡ä»¶
                let m3u8Content;
                let fetchSuccess = false;
                
                try {
                    // æ–¹æ³•1: ç›´æ¥fetch
                    const response = await fetch(url, {
                        mode: 'cors',
                        headers: {
                            'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'
                        }
                    });
                    
                    if (response.ok) {
                        m3u8Content = await response.text();
                        fetchSuccess = true;
                        log('M3U8 æ–‡ä»¶è§£ææˆåŠŸ (ç›´æ¥è·å–)');
                    } else {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                } catch (corsError) {
                    log(`ç›´æ¥è·å–å¤±è´¥: ${corsError.message}`, 'warning');
                    
                    // æ–¹æ³•2: å°è¯•ä½¿ç”¨ä»£ç†
                    try {
                        const proxyUrl = `https://cors-anywhere.herokuapp.com/${url}`;
                        const proxyResponse = await fetch(proxyUrl);
                        
                        if (proxyResponse.ok) {
                            m3u8Content = await proxyResponse.text();
                            fetchSuccess = true;
                            log('M3U8 æ–‡ä»¶è§£ææˆåŠŸ (ä»£ç†è·å–)');
                        } else {
                            throw new Error(`ä»£ç†è¯·æ±‚å¤±è´¥: ${proxyResponse.status}`);
                        }
                    } catch (proxyError) {
                        log(`ä»£ç†è·å–å¤±è´¥: ${proxyError.message}`, 'warning');
                        
                        // æ–¹æ³•3: æ˜¾ç¤ºæ‰‹åŠ¨è¾“å…¥é€‰é¡¹
                        showManualInputOption(url);
                        return;
                    }
                }
                
                if (fetchSuccess && m3u8Content) {
                    // æ£€æŸ¥æ˜¯å¦æœ‰åŠ å¯†
                    checkEncryption(m3u8Content);
                    
                    // è§£æç‰‡æ®µ
                    parseSegments(m3u8Content);
                } else {
                    throw new Error('æ— æ³•è·å–M3U8æ–‡ä»¶å†…å®¹');
                }
                
            } catch (error) {
                log(`è§£æå¤±è´¥: ${error.message}`, 'error');
                showAlert(`è§£æå¤±è´¥: ${error.message}`, 'error');
                
                // æ˜¾ç¤º FFmpeg å»ºè®®
                showFFmpegSuggestion(url);
            }
        }

        // æ£€æŸ¥åŠ å¯†
        function checkEncryption(content) {
            const lines = content.split('\\n');
            const keyLine = lines.find(line => line.includes('#EXT-X-KEY:'));
            
            if (keyLine) {
                log('æ£€æµ‹åˆ°åŠ å¯†è§†é¢‘', 'warning');
                
                // è§£æåŠ å¯†ä¿¡æ¯
                const method = keyLine.match(/METHOD=([^,]+)/)?.[1];
                const keyUri = keyLine.match(/URI="([^"]+)"/)?.[1];
                const iv = keyLine.match(/IV=([^,\\s]+)/)?.[1];
                
                if (method === 'AES-128') {
                    log(`åŠ å¯†æ–¹å¼: ${method}`, 'info');
                    log(`å¯†é’¥åœ°å€: ${keyUri}`, 'info');
                    if (iv) log(`åˆå§‹å‘é‡: ${iv}`, 'info');
                    
                    // æ˜¾ç¤ºåŠ å¯†ä¿¡æ¯
                    document.getElementById('encryptionInfo').classList.remove('hidden');
                    
                    // å°è¯•è·å–å¯†é’¥
                    fetchEncryptionKey(keyUri, iv);
                }
            } else {
                log('æœªæ£€æµ‹åˆ°åŠ å¯†ï¼Œä½¿ç”¨æ ‡å‡†ä¸‹è½½æ–¹å¼', 'success');
            }
        }

        // è·å–åŠ å¯†å¯†é’¥
        async function fetchEncryptionKey(keyUri, iv) {
            try {
                const keyUrl = keyUri.startsWith('http') ? keyUri : baseUrl + keyUri;
                const response = await fetch(keyUrl);
                
                if (response.ok) {
                    const keyData = await response.arrayBuffer();
                    encryptionKey = new Uint8Array(keyData);
                    encryptionIV = iv;
                    log('åŠ å¯†å¯†é’¥è·å–æˆåŠŸ', 'success');
                } else {
                    log('åŠ å¯†å¯†é’¥è·å–å¤±è´¥ï¼Œå¯èƒ½éœ€è¦ç‰¹æ®Šå¤„ç†', 'warning');
                }
            } catch (error) {
                log(`å¯†é’¥è·å–å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // è§£æè§†é¢‘ç‰‡æ®µ
        function parseSegments(content) {
            segments = [];
            const lines = content.split('\\n');
            
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                if (line && !line.startsWith('#') && (line.includes('.ts') || line.includes('.m4s'))) {
                    const segmentUrl = line.startsWith('http') ? line : baseUrl + line;
                    segments.push({
                        url: segmentUrl,
                        index: segments.length,
                        status: 'pending',
                        data: null
                    });
                }
            }
            
            if (segments.length === 0) {
                showAlert('æœªæ‰¾åˆ°è§†é¢‘ç‰‡æ®µï¼Œè¯·æ£€æŸ¥ M3U8 æ–‡ä»¶æ ¼å¼', 'error');
                return;
            }
            
            log(`æ‰¾åˆ° ${segments.length} ä¸ªè§†é¢‘ç‰‡æ®µ`);
            showAlert(`è§£ææˆåŠŸï¼æ‰¾åˆ° ${segments.length} ä¸ªè§†é¢‘ç‰‡æ®µ`, 'success');
            
            // æ˜¾ç¤ºç»Ÿè®¡ä¿¡æ¯
            document.getElementById('statsSection').classList.remove('hidden');
            updateStats();
            
            // å¼€å§‹ä¸‹è½½
            startDownload();
        }

        // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
        function updateStats() {
            const total = segments.length;
            const downloaded = segments.filter(s => s.status === 'success').length;
            const failed = segments.filter(s => s.status === 'error').length;
            const progress = total > 0 ? Math.round((downloaded / total) * 100) : 0;
            
            document.getElementById('totalSegments').textContent = total;
            document.getElementById('downloadedSegments').textContent = downloaded;
            document.getElementById('failedSegments').textContent = failed;
            document.getElementById('downloadProgress').textContent = progress + '%';
            
            // æ›´æ–°è¿›åº¦æ¡
            document.getElementById('progressBar').classList.remove('hidden');
            document.getElementById('progressFill').style.width = progress + '%';
        }

        // å¼€å§‹ä¸‹è½½
        async function startDownload() {
            if (isDownloading) return;
            
            isDownloading = true;
            log('å¼€å§‹ä¸‹è½½è§†é¢‘ç‰‡æ®µ...');
            
            // å¹¶å‘ä¸‹è½½
            const concurrency = 3; // é™ä½å¹¶å‘æ•°ä»¥é¿å…æœåŠ¡å™¨é™åˆ¶
            
            for (let i = 0; i < segments.length; i += concurrency) {
                const batch = segments.slice(i, i + concurrency);
                await Promise.all(batch.map(segment => downloadSegment(segment)));
                
                // æ›´æ–°ç»Ÿè®¡
                updateStats();
                
                // çŸ­æš‚å»¶è¿Ÿé¿å…æœåŠ¡å™¨é™åˆ¶
                await new Promise(resolve => setTimeout(resolve, 100));
            }
            
            isDownloading = false;
            log('ä¸‹è½½å®Œæˆ');
            
            // æ£€æŸ¥ç»“æœ
            const failed = segments.filter(s => s.status === 'error').length;
            if (failed > 0) {
                showAlert(`ä¸‹è½½å®Œæˆï¼Œä½†æœ‰ ${failed} ä¸ªç‰‡æ®µå¤±è´¥`, 'warning');
            } else {
                showAlert('æ‰€æœ‰ç‰‡æ®µä¸‹è½½æˆåŠŸï¼', 'success');
                // è‡ªåŠ¨åˆå¹¶
                await mergeSegments();
            }
        }

        // ä¸‹è½½å•ä¸ªç‰‡æ®µ
        async function downloadSegment(segment) {
            try {
                const response = await fetch(segment.url);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                let data = await response.arrayBuffer();
                
                // å¦‚æœæœ‰åŠ å¯†ï¼Œå°è¯•è§£å¯†
                if (encryptionKey && encryptionIV) {
                    data = await decryptSegment(data, encryptionKey, encryptionIV);
                }
                
                segment.data = data;
                segment.status = 'success';
                
                log(`ç‰‡æ®µ ${segment.index + 1} ä¸‹è½½æˆåŠŸ`);
                
            } catch (error) {
                segment.status = 'error';
                log(`ç‰‡æ®µ ${segment.index + 1} ä¸‹è½½å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // AES-128 è§£å¯†ï¼ˆç®€åŒ–ç‰ˆï¼‰
        async function decryptSegment(data, key, iv) {
            try {
                // è¿™é‡Œåº”è¯¥å®ç° AES-128 è§£å¯†
                // ç”±äº Web Crypto API çš„é™åˆ¶ï¼Œå®é™…é¡¹ç›®ä¸­å¯èƒ½éœ€è¦ä½¿ç”¨ä¸“é—¨çš„åŠ å¯†åº“
                log('å°è¯•è§£å¯†ç‰‡æ®µ...', 'info');
                
                // æš‚æ—¶è¿”å›åŸå§‹æ•°æ®
                return data;
            } catch (error) {
                log(`è§£å¯†å¤±è´¥: ${error.message}`, 'error');
                return data;
            }
        }

        // åˆå¹¶ç‰‡æ®µ
        async function mergeSegments() {
            const format = document.querySelector('input[name="format"]:checked').value;
            const successSegments = segments.filter(s => s.status === 'success' && s.data);
            
            if (successSegments.length === 0) {
                showAlert('æ²¡æœ‰å¯ç”¨çš„è§†é¢‘ç‰‡æ®µ', 'error');
                return;
            }
            
            log(`å¼€å§‹åˆå¹¶ ${successSegments.length} ä¸ªç‰‡æ®µ...`);
            
            // è®¡ç®—æ€»å¤§å°
            const totalSize = successSegments.reduce((sum, segment) => sum + segment.data.byteLength, 0);
            
            // åˆ›å»ºåˆå¹¶åçš„æ•°æ®
            const mergedData = new Uint8Array(totalSize);
            let offset = 0;
            
            for (const segment of successSegments) {
                mergedData.set(new Uint8Array(segment.data), offset);
                offset += segment.data.byteLength;
            }
            
            // ä¸‹è½½æ–‡ä»¶
            const blob = new Blob([mergedData], { 
                type: format === 'mp4' ? 'video/mp4' : 'video/mp2t' 
            });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `video_${Date.now()}.${format}`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            log(`${format.toUpperCase()} è§†é¢‘ä¸‹è½½å®Œæˆ`);
            showAlert(`è§†é¢‘ä¸‹è½½å®Œæˆï¼`, 'success');
        }

        // ç”Ÿæˆ FFmpeg å‘½ä»¤
        function generateFFmpegCommand() {
            const url = document.getElementById('ffmpegUrl').value.trim();
            if (!url) {
                showAlert('è¯·è¾“å…¥ M3U8 é“¾æ¥åœ°å€', 'error');
                return;
            }
            
            const format = document.querySelector('input[name="ffmpeg-format"]:checked').value;
            const timestamp = Date.now();
            
            const command = `ffmpeg -protocol_whitelist file,http,https,tcp,tls,crypto -i "${url}" -c copy "video_${timestamp}.${format}" -y`;
            
            document.getElementById('ffmpegCommand').textContent = command;
            document.getElementById('ffmpegCommand').classList.remove('hidden');
            
            log('FFmpeg å‘½ä»¤ç”ŸæˆæˆåŠŸ', 'success');
            showAlert('FFmpeg å‘½ä»¤å·²ç”Ÿæˆï¼Œè¯·å¤åˆ¶åˆ°ç»ˆç«¯æ‰§è¡Œ', 'success');
        }

        // å¤åˆ¶ FFmpeg å‘½ä»¤
        function copyFFmpegCommand() {
            const command = document.getElementById('ffmpegCommand').textContent;
            if (!command) {
                showAlert('è¯·å…ˆç”Ÿæˆ FFmpeg å‘½ä»¤', 'error');
                return;
            }
            
            navigator.clipboard.writeText(command).then(() => {
                showAlert('å‘½ä»¤å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
            }).catch(() => {
                showAlert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶', 'error');
            });
        }

        // æ‰§è¡Œ FFmpegï¼ˆWebAssembly ç‰ˆæœ¬ï¼‰
        async function executeFFmpeg() {
            const url = document.getElementById('ffmpegUrl').value.trim();
            if (!url) {
                showAlert('è¯·è¾“å…¥ M3U8 é“¾æ¥åœ°å€', 'error');
                return;
            }
            
            if (!ffmpegLoaded) {
                showAlert('FFmpeg è¿˜æœªåŠ è½½å®Œæˆï¼Œè¯·ç¨å€™...', 'warning');
                await initFFmpeg();
                return;
            }
            
            if (isFFmpegProcessing) {
                showAlert('FFmpeg æ­£åœ¨å¤„ç†ä¸­ï¼Œè¯·å‹¿é‡å¤æ‰§è¡Œ', 'warning');
                return;
            }
            
            try {
                isFFmpegProcessing = true;
                log('å¼€å§‹ä½¿ç”¨ FFmpeg WebAssembly å¤„ç†è§†é¢‘...', 'info');
                showAlert('å¼€å§‹å¤„ç†è§†é¢‘ï¼Œè¯·ç¨å€™...', 'info');
                
                const format = document.querySelector('input[name="ffmpeg-format"]:checked').value;
                const timestamp = Date.now();
                const outputFileName = `video_${timestamp}.${format}`;
                
                // æ˜¾ç¤ºè¿›åº¦
                document.getElementById('progressBar').classList.remove('hidden');
                document.getElementById('statsSection').classList.remove('hidden');
                
                // æ‰§è¡Œ FFmpeg å‘½ä»¤
                await ffmpeg.exec([
                    '-protocol_whitelist', 'file,http,https,tcp,tls,crypto',
                    '-i', url,
                    '-c', 'copy',
                    '-y',
                    outputFileName
                ]);
                
                // è·å–è¾“å‡ºæ–‡ä»¶
                const data = await ffmpeg.readFile(outputFileName);
                
                // ä¸‹è½½æ–‡ä»¶
                const blob = new Blob([data], { 
                    type: format === 'mp4' ? 'video/mp4' : format === 'mkv' ? 'video/x-matroska' : 'video/mp2t' 
                });
                const downloadUrl = URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = downloadUrl;
                a.download = outputFileName;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(downloadUrl);
                
                // æ¸…ç† FFmpeg æ–‡ä»¶ç³»ç»Ÿ
                await ffmpeg.deleteFile(outputFileName);
                
                log('è§†é¢‘å¤„ç†å®Œæˆï¼', 'success');
                showAlert('è§†é¢‘å¤„ç†å®Œæˆå¹¶å·²å¼€å§‹ä¸‹è½½ï¼', 'success');
                
            } catch (error) {
                log(`FFmpeg å¤„ç†å¤±è´¥: ${error.message}`, 'error');
                showAlert(`è§†é¢‘å¤„ç†å¤±è´¥: ${error.message}`, 'error');
                
                // å¦‚æœ WebAssembly å¤±è´¥ï¼Œå›é€€åˆ°ç”Ÿæˆå‘½ä»¤
                log('å›é€€åˆ°ç”Ÿæˆå‘½ä»¤æ¨¡å¼...', 'info');
                generateFFmpegCommand();
                showAlert('WebAssembly å¤„ç†å¤±è´¥ï¼Œå·²ç”Ÿæˆå‘½ä»¤ä¾›ç»ˆç«¯ä½¿ç”¨', 'warning');
                
            } finally {
                isFFmpegProcessing = false;
                document.getElementById('progressBar').classList.add('hidden');
            }
        }

        // é«˜çº§ FFmpeg å¤„ç†ï¼ˆæ”¯æŒæ›´å¤šé€‰é¡¹ï¼‰
        async function executeAdvancedFFmpeg(inputUrl, options = {}) {
            if (!ffmpegLoaded) {
                await initFFmpeg();
            }
            
            try {
                isFFmpegProcessing = true;
                log('å¼€å§‹é«˜çº§ FFmpeg å¤„ç†...', 'info');
                
                const {
                    format = 'mp4',
                    videoBitrate = null,
                    audioBitrate = null,
                    resolution = null,
                    fps = null,
                    codec = 'copy'
                } = options;
                
                const timestamp = Date.now();
                const outputFileName = `video_${timestamp}.${format}`;
                
                // æ„å»º FFmpeg å‚æ•°
                const args = [
                    '-protocol_whitelist', 'file,http,https,tcp,tls,crypto',
                    '-i', inputUrl
                ];
                
                // æ·»åŠ è§†é¢‘ç¼–ç é€‰é¡¹
                if (codec !== 'copy') {
                    args.push('-c:v', codec);
                    if (videoBitrate) args.push('-b:v', videoBitrate);
                    if (resolution) args.push('-s', resolution);
                    if (fps) args.push('-r', fps);
                } else {
                    args.push('-c', 'copy');
                }
                
                // æ·»åŠ éŸ³é¢‘é€‰é¡¹
                if (audioBitrate) {
                    args.push('-c:a', 'aac');
                    args.push('-b:a', audioBitrate);
                }
                
                args.push('-y', outputFileName);
                
                log(`FFmpeg å‚æ•°: ${args.join(' ')}`, 'info');
                
                // æ‰§è¡Œå‘½ä»¤
                await ffmpeg.exec(args);
                
                // è·å–å’Œä¸‹è½½æ–‡ä»¶
                const data = await ffmpeg.readFile(outputFileName);
                const blob = new Blob([data], { 
                    type: format === 'mp4' ? 'video/mp4' : format === 'mkv' ? 'video/x-matroska' : 'video/mp2t' 
                });
                
                const downloadUrl = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = downloadUrl;
                a.download = outputFileName;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(downloadUrl);
                
                await ffmpeg.deleteFile(outputFileName);
                
                log('é«˜çº§ FFmpeg å¤„ç†å®Œæˆï¼', 'success');
                return outputFileName;
                
            } catch (error) {
                log(`é«˜çº§ FFmpeg å¤„ç†å¤±è´¥: ${error.message}`, 'error');
                throw error;
            } finally {
                isFFmpegProcessing = false;
            }
        }

        // æ˜¾ç¤ºé«˜çº§é€‰é¡¹
        function showAdvancedOptions() {
            document.getElementById('advancedOptions').classList.remove('hidden');
        }

        // éšè—é«˜çº§é€‰é¡¹
        function hideAdvancedOptions() {
            document.getElementById('advancedOptions').classList.add('hidden');
        }

        // ä»UIæ‰§è¡Œé«˜çº§FFmpegå¤„ç†
        async function executeAdvancedFFmpegFromUI() {
            const url = document.getElementById('ffmpegUrl').value.trim();
            if (!url) {
                showAlert('è¯·è¾“å…¥ M3U8 é“¾æ¥åœ°å€', 'error');
                return;
            }

            const format = document.querySelector('input[name="ffmpeg-format"]:checked').value;
            const options = {
                format: format,
                codec: document.getElementById('videoCodec').value,
                videoBitrate: document.getElementById('videoBitrate').value || null,
                audioBitrate: document.getElementById('audioBitrate').value || null,
                resolution: document.getElementById('resolution').value || null,
                fps: document.getElementById('fps').value || null
            };

            try {
                showAlert('å¼€å§‹é«˜çº§å¤„ç†ï¼Œè¯·ç¨å€™...', 'info');
                await executeAdvancedFFmpeg(url, options);
                showAlert('é«˜çº§å¤„ç†å®Œæˆï¼', 'success');
            } catch (error) {
                showAlert(`é«˜çº§å¤„ç†å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // æ£€æŸ¥æµè§ˆå™¨æ”¯æŒ
            if (!window.SharedArrayBuffer) {
                showAlert('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒ SharedArrayBufferï¼ŒWebAssembly FFmpeg å¯èƒ½æ— æ³•æ­£å¸¸å·¥ä½œã€‚å»ºè®®ä½¿ç”¨æœ€æ–°ç‰ˆæœ¬çš„ Chrome æˆ– Firefoxã€‚', 'warning');
            }
            
            // æ·»åŠ  FFmpeg çŠ¶æ€æŒ‡ç¤ºå™¨
            const ffmpegSection = document.querySelector('.ffmpeg-section h3');
            if (ffmpegSection) {
                ffmpegSection.innerHTML = 'âš¡ FFmpeg ä¸“ä¸šä¸‹è½½ <span class="status-indicator status-loading" id="ffmpegStatus">â³ æœªåˆå§‹åŒ–</span>';
            }
        });

        // æ›´æ–° FFmpeg çŠ¶æ€
        function updateFFmpegStatus(status, message) {
            const statusEl = document.getElementById('ffmpegStatus');
            if (statusEl) {
                statusEl.className = `status-indicator status-${status}`;
                statusEl.textContent = message;
            }
        }

        // å¤„ç†æœ¬åœ°æ–‡ä»¶
        function handleLocalFile() {
            const fileInput = document.getElementById('localFile');
            const file = fileInput.files[0];
            
            if (file) {
                currentLocalFile = file;
                log(`é€‰æ‹©äº†æœ¬åœ°æ–‡ä»¶: ${file.name}`, 'info');
                showAlert(`å·²é€‰æ‹©æ–‡ä»¶: ${file.name}`, 'success');
            }
        }

        // è§£ææœ¬åœ° M3U8 æ–‡ä»¶
        function parseLocalM3U8() {
            if (!currentLocalFile) {
                showAlert('è¯·å…ˆé€‰æ‹©æœ¬åœ°æ–‡ä»¶', 'error');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const content = e.target.result;
                log('æœ¬åœ°æ–‡ä»¶è¯»å–æˆåŠŸ', 'success');
                
                // åˆ†ææ–‡ä»¶å†…å®¹
                analyzeLocalM3U8(content);
            };
            
            reader.readAsText(currentLocalFile);
        }

        // åˆ†ææœ¬åœ° M3U8 æ–‡ä»¶
        function analyzeLocalM3U8(content) {
            const lines = content.split('\\n');
            let segmentCount = 0;
            let hasEncryption = false;
            let totalDuration = 0;
            
            for (const line of lines) {
                if (line.includes('.ts') || line.includes('.m4s')) {
                    segmentCount++;
                } else if (line.includes('#EXT-X-KEY:')) {
                    hasEncryption = true;
                } else if (line.includes('#EXTINF:')) {
                    const duration = parseFloat(line.match(/#EXTINF:([\\d.]+)/)?.[1] || 0);
                    totalDuration += duration;
                }
            }
            
            log(`æ–‡ä»¶åˆ†æå®Œæˆ:`);
            log(`- ç‰‡æ®µæ•°é‡: ${segmentCount}`);
            log(`- æ€»æ—¶é•¿: ${Math.round(totalDuration)} ç§’`);
            log(`- æ˜¯å¦åŠ å¯†: ${hasEncryption ? 'æ˜¯' : 'å¦'}`);
            
            if (hasEncryption) {
                showAlert('æ£€æµ‹åˆ°åŠ å¯†è§†é¢‘ï¼Œå»ºè®®ä½¿ç”¨ FFmpeg æ–¹å¼å¤„ç†', 'warning');
            }
        }

        // ç”Ÿæˆæœ¬åœ°æ–‡ä»¶ FFmpeg å‘½ä»¤
        function generateLocalFFmpegCommand() {
            if (!currentLocalFile) {
                showAlert('è¯·å…ˆé€‰æ‹©æœ¬åœ°æ–‡ä»¶', 'error');
                return;
            }
            
            const format = 'mp4';
            const timestamp = Date.now();
            const filePath = currentLocalFile.name;
            
            const command = `ffmpeg -protocol_whitelist file,http,https,tcp,tls,crypto -i "${filePath}" -c copy "video_${timestamp}.${format}" -y`;
            
            document.getElementById('ffmpegCommand').textContent = command;
            document.getElementById('ffmpegCommand').classList.remove('hidden');
            
            log('æœ¬åœ°æ–‡ä»¶ FFmpeg å‘½ä»¤ç”ŸæˆæˆåŠŸ', 'success');
            showAlert('FFmpeg å‘½ä»¤å·²ç”Ÿæˆï¼Œè¯·åœ¨æ–‡ä»¶æ‰€åœ¨ç›®å½•çš„ç»ˆç«¯æ‰§è¡Œ', 'success');
        }

        // å¤„ç†æœ¬åœ°æ–‡ä»¶
        // æ˜¾ç¤ºæ‰‹åŠ¨è¾“å…¥é€‰é¡¹
        function showManualInputOption(url) {
            const manualInputHtml = `
                <div class="alert alert-warning">
                    <h4>ğŸ”’ æ— æ³•ç›´æ¥è·å–M3U8æ–‡ä»¶</h4>
                    <p>ç”±äºCORSé™åˆ¶ï¼Œæ— æ³•ç›´æ¥è§£æM3U8æ–‡ä»¶ã€‚è¯·é€‰æ‹©ä»¥ä¸‹æ–¹å¼ä¹‹ä¸€ï¼š</p>
                    <div style="margin-top: 15px;">
                        <button class="btn btn-primary" onclick="showManualPasteArea('${url}')">æ‰‹åŠ¨ç²˜è´´M3U8å†…å®¹</button>
                        <button class="btn btn-success" onclick="switchToFFmpeg('${url}')">ä½¿ç”¨FFmpegä¸‹è½½</button>
                        <button class="btn btn-info" onclick="showCorsHelp()">äº†è§£CORSé—®é¢˜</button>
                    </div>
                </div>
            `;
            
            const mainContent = document.querySelector('.main-content');
            const alertDiv = document.createElement('div');
            alertDiv.innerHTML = manualInputHtml;
            mainContent.appendChild(alertDiv);
            
            setTimeout(() => {
                alertDiv.remove();
            }, 30000);
        }

        // æ˜¾ç¤ºæ‰‹åŠ¨ç²˜è´´åŒºåŸŸ
        function showManualPasteArea(url) {
            const pasteAreaHtml = `
                <div class="input-section" id="manualPasteArea">
                    <h3>ğŸ“‹ æ‰‹åŠ¨ç²˜è´´M3U8å†…å®¹</h3>
                    <p>è¯·æ‰‹åŠ¨è®¿é—®M3U8é“¾æ¥ï¼Œå¤åˆ¶å†…å®¹å¹¶ç²˜è´´åˆ°ä¸‹æ–¹ï¼š</p>
                    <div style="margin-bottom: 15px;">
                        <strong>M3U8é“¾æ¥:</strong> <a href="${url}" target="_blank">${url}</a>
                    </div>
                    <textarea id="manualM3u8Content" placeholder="è¯·ç²˜è´´M3U8æ–‡ä»¶å†…å®¹..." style="width: 100%; height: 200px; padding: 10px; border: 2px solid #dee2e6; border-radius: 8px; font-family: monospace; font-size: 14px;"></textarea>
                    <div style="margin-top: 15px;">
                        <button class="btn btn-primary" onclick="parseManualContent('${url}')">è§£æå†…å®¹</button>
                        <button class="btn btn-secondary" onclick="document.getElementById('manualPasteArea').remove()">å–æ¶ˆ</button>
                    </div>
                </div>
            `;
            
            const mainContent = document.querySelector('.main-content');
            const existingArea = document.getElementById('manualPasteArea');
            if (existingArea) {
                existingArea.remove();
            }
            
            const pasteDiv = document.createElement('div');
            pasteDiv.innerHTML = pasteAreaHtml;
            mainContent.appendChild(pasteDiv);
        }

        // è§£ææ‰‹åŠ¨è¾“å…¥çš„å†…å®¹
        function parseManualContent(url) {
            const content = document.getElementById('manualM3u8Content').value.trim();
            if (!content) {
                showAlert('è¯·ç²˜è´´M3U8æ–‡ä»¶å†…å®¹', 'error');
                return;
            }

            try {
                baseUrl = url.substring(0, url.lastIndexOf('/') + 1);
                log('å¼€å§‹è§£ææ‰‹åŠ¨è¾“å…¥çš„M3U8å†…å®¹...');
                
                // æ£€æŸ¥æ˜¯å¦æœ‰åŠ å¯†
                checkEncryption(content);
                
                // è§£æç‰‡æ®µ
                parseSegments(content);
                
                // ç§»é™¤æ‰‹åŠ¨è¾“å…¥åŒºåŸŸ
                document.getElementById('manualPasteArea').remove();
                
                log('æ‰‹åŠ¨è¾“å…¥çš„M3U8å†…å®¹è§£ææˆåŠŸ');
                showAlert('M3U8å†…å®¹è§£ææˆåŠŸï¼', 'success');
                
            } catch (error) {
                log(`æ‰‹åŠ¨è§£æå¤±è´¥: ${error.message}`, 'error');
                showAlert(`è§£æå¤±è´¥: ${error.message}`, 'error');
            }
        }

        // æ˜¾ç¤ºCORSå¸®åŠ©ä¿¡æ¯
        function showCorsHelp() {
            const helpHtml = `
                <div class="alert alert-info">
                    <h4>ğŸ”’ å…³äºCORSé™åˆ¶</h4>
                    <p><strong>CORS (è·¨åŸŸèµ„æºå…±äº«)</strong> æ˜¯æµè§ˆå™¨çš„å®‰å…¨æœºåˆ¶ï¼Œé˜²æ­¢ç½‘é¡µè®¿é—®å…¶ä»–åŸŸåçš„èµ„æºã€‚</p>
                    <h5>è§£å†³æ–¹æ¡ˆï¼š</h5>
                    <ul>
                        <li><strong>ä½¿ç”¨FFmpeg:</strong> æœ€æ¨èçš„æ–¹å¼ï¼Œç»•è¿‡æ‰€æœ‰é™åˆ¶</li>
                        <li><strong>æ‰‹åŠ¨ç²˜è´´:</strong> ç›´æ¥è®¿é—®M3U8é“¾æ¥ï¼Œå¤åˆ¶å†…å®¹ç²˜è´´</li>
                        <li><strong>æµè§ˆå™¨æ’ä»¶:</strong> å®‰è£…CORSæ’ä»¶ä¸´æ—¶ç¦ç”¨é™åˆ¶</li>
                        <li><strong>å‘½ä»¤è¡Œå·¥å…·:</strong> ä½¿ç”¨æˆ‘ä»¬æä¾›çš„shellè„šæœ¬</li>
                    </ul>
                    <div style="margin-top: 15px;">
                        <button class="btn btn-primary" onclick="this.parentElement.parentElement.remove()">æˆ‘çŸ¥é“äº†</button>
                    </div>
                </div>
            `;
            
            const mainContent = document.querySelector('.main-content');
            const helpDiv = document.createElement('div');
            helpDiv.innerHTML = helpHtml;
            mainContent.appendChild(helpDiv);
        }

        function processLocalFile() {
            generateLocalFFmpegCommand();
        }

        // æ˜¾ç¤º FFmpeg å»ºè®®
        function showFFmpegSuggestion(url) {
            const suggestion = `
                <div class="alert alert-info">
                    <h4>ğŸ’¡ å»ºè®®ä½¿ç”¨ FFmpeg ä¸‹è½½</h4>
                    <p>æ£€æµ‹åˆ°æ­¤è§†é¢‘å¯èƒ½ä½¿ç”¨äº†åŠ å¯†æˆ–ç‰¹æ®Šæ ¼å¼ï¼Œå»ºè®®åˆ‡æ¢åˆ° "FFmpeg ä¸‹è½½" æ–¹å¼ã€‚</p>
                    <button class="btn btn-primary" onclick="switchToFFmpeg('${url}')">åˆ‡æ¢åˆ° FFmpeg</button>
                </div>
            `;
            
            const mainContent = document.querySelector('.main-content');
            const alertDiv = document.createElement('div');
            alertDiv.innerHTML = suggestion;
            mainContent.insertBefore(alertDiv, mainContent.firstChild);
        }

        // åˆ‡æ¢åˆ° FFmpeg æ–¹å¼
        function switchToFFmpeg(url) {
            switchTab('ffmpeg');
            document.getElementById('ffmpegUrl').value = url;
            generateFFmpegCommand();
        }

        // é‡è¯•å¤±è´¥ç‰‡æ®µ
        async function retryFailedSegments() {
            const failed = segments.filter(s => s.status === 'error');
            if (failed.length === 0) {
                showAlert('æ²¡æœ‰å¤±è´¥çš„ç‰‡æ®µéœ€è¦é‡è¯•', 'info');
                return;
            }
            
            log(`å¼€å§‹é‡è¯• ${failed.length} ä¸ªå¤±è´¥ç‰‡æ®µ...`);
            
            for (const segment of failed) {
                await downloadSegment(segment);
                updateStats();
            }
            
            showAlert('é‡è¯•å®Œæˆ', 'success');
        }

        // å¼ºåˆ¶ä¸‹è½½
        async function forceDownload() {
            await mergeSegments();
        }

        // æ¸…ç©ºæ‰€æœ‰æ•°æ®
        function clearAll() {
            segments = [];
            downloadedSegments = [];
            failedSegments = [];
            isDownloading = false;
            encryptionKey = null;
            encryptionIV = null;
            currentLocalFile = null;
            
            document.getElementById('m3u8Url').value = '';
            document.getElementById('ffmpegUrl').value = '';
            document.getElementById('localFile').value = '';
            document.getElementById('statsSection').classList.add('hidden');
            document.getElementById('progressBar').classList.add('hidden');
            document.getElementById('encryptionInfo').classList.add('hidden');
            document.getElementById('ffmpegCommand').classList.add('hidden');
            document.getElementById('logSection').classList.add('hidden');
            
            showAlert('å·²æ¸…ç©ºæ‰€æœ‰æ•°æ®', 'info');
        }

        // é”®ç›˜å¿«æ·é”®
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey && e.key === 'Enter') {
                parseM3U8();
            } else if (e.ctrlKey && e.key === 'r') {
                e.preventDefault();
                retryFailedSegments();
            }
        });
    </script>
</body>
</html>